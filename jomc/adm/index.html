<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          'primary': {
            50: '#f0fdf4', 100: '#ecfdf5', 200: '#d1fae5', 300: '#a7f3d0', 
            400: '#6ee7b7', 500: '#10b981', 
            600: '#059669', 
            700: '#047857', 800: '#065f46', 900: '#064e3b', 950: '#022c22' 
          },
        },
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
        },
      }
    }
  }
</script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
  
  body {
    transition: background-color 0.3s, color 0.3s;
    font-family: 'Inter', sans-serif;
  }
  
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  .dark ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
  .light ::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 4px; }

  .dark {
    --tw-bg-opacity: 1;
    background-color: rgb(17 24 39 / var(--tw-bg-opacity));
    color: #e5e7eb;
  }

  .card {
    background-color: #ffffff; 
    border-radius: 0.75rem; 
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); 
    padding: 1.5rem; 
    border: 1px solid #f3f4f6; 
    transition: all 300ms;
  }
  .dark .card {
    background-color: #1f2937; 
    border-color: rgba(55, 65, 81, 0.5);
  }

  .delete-button {
    padding: 0.375rem 0.75rem; 
    border-radius: 0.5rem; 
    font-size: 0.875rem; 
    font-weight: 500; 
    transition: background-color 0.15s ease-in-out;
    outline: none;
    
    background-color: #dc2626; 
    color: white; 
  }
  .delete-button:hover {
    background-color: #b91c1c; 
  }
  .delete-button:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
    box-shadow: 0 0 0 2px white, 0 0 0 4px #ef4444; 
  }
  .dark .delete-button:focus {
    box-shadow: 0 0 0 2px #1f2937, 0 0 0 4px #ef4444; 
  }
</style>
</head>

<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 min-h-screen">

<header class="bg-primary-600 dark:bg-primary-700 shadow-xl sticky top-0 z-10">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
    <h1 class="text-2xl font-extrabold text-white flex items-center">
      <i class="fas fa-cogs w-6 h-6 mr-3"></i>
      Admin Panel
    </h1>
    <div class="flex items-center space-x-4">
        <div id="authStatus" class="text-sm font-medium text-white px-3 py-1 bg-red-500 rounded-full hidden">
            Auth Required
        </div>
        <button id="themeToggle" onclick="toggleTheme()" class="p-2 rounded-full text-white hover:bg-primary-500/30 transition-colors">
            <i class="fas fa-sun w-6 h-6" id="themeIcon"></i>
        </button>
    </div>
  </div>
</header>

<div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
  
  <div id="mainContent" class="space-y-8">
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        
        <div class="card p-4 flex items-center space-x-4 bg-primary-50 dark:bg-gray-700/50">
            <div class="p-3 rounded-full bg-primary-200 text-primary-700 dark:bg-primary-800 dark:text-primary-200">
                <i class="fas fa-users w-5 h-5"></i>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Users</p>
                <p id="totalUsersStat" class="text-2xl font-bold text-gray-900 dark:text-gray-100">0</p>
            </div>
        </div>

        <div class="card p-4 flex items-center space-x-4 bg-primary-50 dark:bg-gray-700/50">
            <div class="p-3 rounded-full bg-primary-200 text-primary-700 dark:bg-primary-800 dark:text-primary-200">
                <i class="fas fa-newspaper w-5 h-5"></i>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Articles</p>
                <p id="totalArticlesStat" class="text-2xl font-bold text-gray-900 dark:text-gray-100">0</p>
            </div>
        </div>

        <div class="card p-4 flex items-center space-x-4 bg-primary-50 dark:bg-gray-700/50">
            <div class="p-3 rounded-full bg-primary-200 text-primary-700 dark:bg-primary-800 dark:text-primary-200">
                <i class="fas fa-comments w-5 h-5"></i>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Comments</p>
                <p id="totalCommentsStat" class="text-2xl font-bold text-gray-900 dark:text-gray-100">0</p>
            </div>
        </div>

        <div class="card p-4 flex items-center justify-between space-x-4 bg-primary-50 dark:bg-gray-700/50">
             <div class="p-3 rounded-full bg-primary-200 text-primary-700 dark:bg-primary-800 dark:text-primary-200">
                <i class="fas fa-server w-5 h-5"></i>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">System Status</p>
                <span id="systemStatus" class="px-3 py-1 rounded-full text-xs font-semibold bg-primary-100 text-primary-800 dark:bg-primary-800 dark:text-primary-100">Operational</span>
            </div>
        </div>
    </div>
    
        <div class="card w-full" id="usersCard">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold flex items-center text-primary-600 dark:text-primary-400">
            <i class="fas fa-users w-6 h-6 mr-2"></i>
            Users Management
        </h3>
              </div>
        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
          <input type="text" id="userSearch" placeholder="Search by username or email..." oninput="renderUsers(1)"
                class="flex-grow min-w-[200px] p-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-gray-50 dark:bg-gray-700 dark:text-white transition-all">
          <div class="flex items-center space-x-2">
            <label for="userLimit" class="text-sm text-gray-700 dark:text-gray-300">Show:</label>
            <select id="userLimit" onchange="renderUsers(1)" 
                class="p-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-gray-50 dark:bg-gray-700 dark:text-white text-sm">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
          </div>
        </div>
            <div class="max-h-[500px] overflow-y-auto overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Username</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Email</th>
              <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Actions</th>
            </tr>
          </thead>
          <tbody id="usersList" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
            <tr><td colspan="3" class="px-3 py-3 text-center text-gray-500 dark:text-gray-400">Loading users...</td></tr>
          </tbody>
        </table>
        <p id="usersEmptyState" class="text-center text-gray-500 dark:text-gray-400 py-4 hidden">No users found.</p>
      </div>
            <div id="userPagination" class="flex justify-between items-center mt-4">
        <span id="userPagingInfo" class="text-sm text-gray-600 dark:text-gray-400"></span>
        <div class="flex space-x-2">
          <button id="userPrev" onclick="changePage('users', -1)" disabled class="px-3 py-1 rounded-lg text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-chevron-left"></i> Prev
          </button>
          <button id="userNext" onclick="changePage('users', 1)" disabled class="px-3 py-1 rounded-lg text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
            Next <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

        <div class="card w-full" id="articlesCard">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold flex items-center text-primary-600 dark:text-primary-400">
            <i class="fas fa-newspaper w-6 h-6 mr-2"></i>
            Articles
        </h3>
              </div>
      <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
        <input type="text" id="articleSearch" placeholder="Search by title or category..." oninput="renderArticles(1)"
             class="flex-grow min-w-[200px] p-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-gray-50 dark:bg-gray-700 dark:text-white transition-all">
        <div class="flex items-center space-x-2">
          <label for="articleLimit" class="text-sm text-gray-700 dark:text-gray-300">Show:</label>
          <select id="articleLimit" onchange="renderArticles(1)" 
              class="p-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-gray-50 dark:bg-gray-700 dark:text-white text-sm">
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
          </select>
        </div>
      </div>
            <div class="max-h-[500px] overflow-y-auto overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Title</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Category</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">User</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Views</th>

              <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Actions</th>
            </tr>
          </thead>
          <tbody id="articlesList" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
            <tr><td colspan="3" class="px-3 py-3 text-center text-gray-500 dark:text-gray-400">Loading articles...</td></tr>
          </tbody>   
        </table>
        <p id="articlesEmptyState" class="text-center text-gray-500 dark:text-gray-400 py-4 hidden">No articles found.</p>
      </div>
            <div id="articlePagination" class="flex justify-between items-center mt-4">
        <span id="articlePagingInfo" class="text-sm text-gray-600 dark:text-gray-400"></span>
        <div class="flex space-x-2">
          <button id="articlePrev" onclick="changePage('articles', -1)" disabled class="px-3 py-1 rounded-lg text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-chevron-left"></i> Prev
          </button>
          <button id="articleNext" onclick="changePage('articles', 1)" disabled class="px-3 py-1 rounded-lg text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
            Next <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

        <div class="card w-full" id="commentsCard">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold flex items-center text-primary-600 dark:text-primary-400">
            <i class="fas fa-comments w-6 h-6 mr-2"></i>
            Comments Feed
        </h3>
              </div>
      <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
        <input type="text" id="commentSearch" placeholder="Search by content or user ID..." oninput="renderComments(1)"
             class="flex-grow min-w-[200px] p-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-gray-50 dark:bg-gray-700 dark:text-white transition-all">
        <div class="flex items-center space-x-2">
          <label for="commentLimit" class="text-sm text-gray-700 dark:text-gray-300">Show:</label>
          <select id="commentLimit" onchange="renderComments(1)" 
              class="p-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-primary-500 focus:border-primary-500 bg-gray-50 dark:bg-gray-700 dark:text-white text-sm">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>

          </select>
        </div>
      </div>
            <div class="max-h-[500px] overflow-y-auto overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Content Preview</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">User ID</th>
              <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Actions</th>
            </tr>
          </thead>
          <tbody id="commentsList" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
            <tr><td colspan="3" class="px-3 py-3 text-center text-gray-500 dark:text-gray-400">Loading comments...</td></tr>
          </tbody>
        </table>
        <p id="commentsEmptyState" class="text-center text-gray-500 dark:text-gray-400 py-4 hidden">No comments found.</p>
      </div>
            <div id="commentPagination" class="flex justify-between items-center mt-4">
        <span id="commentPagingInfo" class="text-sm text-gray-600 dark:text-gray-400"></span>
        <div class="flex space-x-2">
          <button id="commentPrev" onclick="changePage('comments', -1)" disabled class="px-3 py-1 rounded-lg text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
            <i class="fas fa-chevron-left"></i> Prev
          </button>
          <button id="commentNext" onclick="changePage('comments', 1)" disabled class="px-3 py-1 rounded-lg text-sm font-medium transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
            Next <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

        <div class="card w-full md:w-fit" id="settingsCard">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold flex items-center text-primary-600 dark:text-primary-400">
            <i class="fas fa-cog w-6 h-6 mr-2"></i>
            System Management
        </h3>
        <span class="text-sm font-mono text-gray-500 dark:text-gray-400">V1.2</span>
      </div>
      <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0">
        <button onclick="runBackup()" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 bg-yellow-600 text-white hover:bg-yellow-700 focus:ring-yellow-500">
            <i class="fas fa-database w-4 h-4 mr-2 inline"></i> Run Database Backup
        </button>
        <button onclick="clearCache()" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500">
            <i class="fas fa-sync-alt w-4 h-4 mr-2 inline"></i> Clear App Cache
        </button>
      </div>
    </div>
    
  </div>
</div>

<div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 z-50 flex items-center justify-center hidden transition-opacity duration-300">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-3xl p-6 w-11/12 max-w-md transform scale-95 transition-transform duration-300">
    <h4 class="text-lg font-bold mb-4 text-gray-900 dark:text-gray-100">Confirm Action</h4>
    <p id="modalMessage" class="mb-6 text-gray-600 dark:text-gray-300"></p>
    <div class="flex justify-end space-x-3">
      <button id="modalCancel" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">Cancel</button>
      <button id="modalConfirm" class="px-3 py-1.5 rounded-lg text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 bg-primary-600 text-white hover:bg-primary-700 focus:ring-primary-500">Confirm</button>
    </div>
  </div>
</div>

<script>
const BASE_URL = "http://127.0.0.1:50000"; 
const admin_id = localStorage.getItem('uid');
const admin_token = localStorage.getItem('token');

let users=[], articles=[], comments=[];
let confirmationCallback = null;

// Pagination State
let userCurrentPage = 1;
let articleCurrentPage = 1;
let commentCurrentPage = 1;

function initTheme() {
    const isDark = (window.matchMedia('(prefers-color-scheme: dark)').matches && !localStorage.getItem('theme')) || localStorage.getItem('theme') === 'dark';
    document.documentElement.classList.toggle('dark', isDark);
    const icon = document.getElementById('themeIcon');
    if (isDark) {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
    } else {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
    }
}

function toggleTheme(){
    const isDark = document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    const icon = document.getElementById('themeIcon');
    if (isDark) {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
    } else {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
    }
}

async function fetchJSON(path, opts={}) {
  try {
    const res = await fetch(`${BASE_URL}${path}`, opts);
    if(!res.ok) {
        console.error(`API Error on ${path}: ${res.status} ${res.statusText}`);
        return null;
    }
    return res.json();
  } catch(error) {
    console.error("Fetch failed:", error);
    return null;
  }
}

const modal = document.getElementById('confirmationModal');
const modalMessage = document.getElementById('modalMessage');
const modalConfirmButton = document.getElementById('modalConfirm');
const modalCancelButton = document.getElementById('modalCancel');

function showConfirmation(message, callback) {
    modalMessage.textContent = message;
    confirmationCallback = callback;
    modal.classList.remove('hidden');
    setTimeout(() => { // Enable transition effect
      modal.querySelector('div').classList.remove('scale-95');
      modal.style.opacity = 1;
    }, 10);
}

function hideConfirmation() {
    modal.querySelector('div').classList.add('scale-95');
    modal.style.opacity = 0;
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300);
}

modalConfirmButton.onclick = () => {
    if (confirmationCallback) {
        confirmationCallback();
    }
    hideConfirmation();
};

modalCancelButton.onclick = hideConfirmation;


function showAuthError() {
    const statusDiv = document.getElementById('authStatus');
    statusDiv.textContent = 'Authentication Failed';
    statusDiv.classList.remove('bg-red-500', 'hidden');
    statusDiv.classList.add('bg-red-600', 'block');
    document.getElementById('mainContent').innerHTML = `<p class="text-center text-xl p-20 text-red-500 dark:text-red-400">
        Authentication token missing or invalid. Please ensure 
        'uid' and 'token' are correctly set in localStorage and refresh.
    </p>`;
}

// --- Pagination Controls Logic ---

function changePage(entity, direction) {
  switch (entity) {
    case 'users':
      userCurrentPage += direction;
      renderUsers();
      break;
    case 'articles':
      articleCurrentPage += direction;
      renderArticles();
      break;
    case 'comments':
      commentCurrentPage += direction;
      renderComments();
      break;
  }
}

// --- User Functions ---

async function loadUsers(){
  const data = await fetchJSON(`/admin/users?id=${admin_id}&token=${admin_token}`);
  users = data?.users || [];
  
  // NEW: Update Stat Card
  document.getElementById('totalUsersStat').textContent = users.length;
  
  userCurrentPage = 1;
  renderUsers();
}

function renderUsers(resetPage = 0){
  const tbody = document.getElementById('usersList');
  const emptyState = document.getElementById('usersEmptyState');
  const search = document.getElementById('userSearch').value.toLowerCase();
  const limit = parseInt(document.getElementById('userLimit').value, 10);
  
  if (resetPage) userCurrentPage = 1;
  
  tbody.innerHTML = '';
  
  // 1. Apply Search/Filter
  const filteredUsers = users.filter(u => 
    u.username.toLowerCase().includes(search) || u.email.toLowerCase().includes(search)
  );
  
  const totalItems = filteredUsers.length;
  const totalPages = Math.ceil(totalItems / limit);

  // Adjust current page if it exceeds total pages
  if (userCurrentPage > totalPages && totalPages > 0) {
    userCurrentPage = totalPages;
  } else if (userCurrentPage < 1 && totalPages > 0) {
    userCurrentPage = 1;
  } else if (totalPages === 0) {
    userCurrentPage = 0;
  }

  if (totalItems === 0) {
     tbody.classList.add('hidden');
     emptyState.classList.remove('hidden');
     document.getElementById('userPagination').classList.add('hidden');
     return;
  }
  
  tbody.classList.remove('hidden');
  emptyState.classList.add('hidden');
  document.getElementById('userPagination').classList.remove('hidden');


  // 2. Apply Pagination (Client-side slicing)
  const offset = (userCurrentPage - 1) * limit;
  const paginatedUsers = filteredUsers.slice(offset, offset + limit);

  paginatedUsers.forEach(u=>{
    const row = document.createElement('tr');
    row.className='hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
    row.innerHTML = `
      <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${u.username}</td>
      <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${u.email}</td>
      <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
          <button onclick="deleteUser('${u.id}')" class="delete-button">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  // 3. Update Pagination UI
  const start = offset + 1;
  const end = Math.min(offset + limit, totalItems);
  document.getElementById('userPagingInfo').textContent = 
    `Showing ${start}-${end} of ${totalItems} users (Page ${userCurrentPage}/${totalPages})`;
  
  document.getElementById('userPrev').disabled = userCurrentPage <= 1;
  document.getElementById('userNext').disabled = userCurrentPage >= totalPages;
}

async function deleteUser(uid){
  showConfirmation(`Are you sure you want to permanently delete user: ${uid}?`, async () => {
    const data = await fetchJSON('/admin/delete_user',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({admin_id, token:admin_token, target_id:uid})
    });
    if (data && data.success) {
        loadUsers(); // Re-load and re-render
    }
  });
}

// --- Article Functions ---

async function loadArticles(){
  const data = await fetchJSON(`/admin/articles?id=${admin_id}&token=${admin_token}`);
  articles = data?.articles || [];
  
  // NEW: Update Stat Card
  document.getElementById('totalArticlesStat').textContent = articles.length;
  
  articleCurrentPage = 1;
  renderArticles();
}

function renderArticles(resetPage = 0){
  const tbody = document.getElementById('articlesList');
  const emptyState = document.getElementById('articlesEmptyState');
  const search = document.getElementById('articleSearch').value.toLowerCase();
  const limit = parseInt(document.getElementById('articleLimit').value, 10);

  if (resetPage) articleCurrentPage = 1;
  
  tbody.innerHTML = '';

  // 1. Apply Search/Filter
  const filteredArticles = articles.filter(a => 
    a.title.toLowerCase().includes(search) || a.categ.toLowerCase().includes(search) || a.sub.toLowerCase().includes(search)
  );
  
  const totalItems = filteredArticles.length;
  const totalPages = Math.ceil(totalItems / limit);

  if (articleCurrentPage > totalPages && totalPages > 0) {
    articleCurrentPage = totalPages;
  } else if (articleCurrentPage < 1 && totalPages > 0) {
    articleCurrentPage = 1;
  } else if (totalPages === 0) {
    articleCurrentPage = 0;
  }
  
  if (totalItems === 0) {
     tbody.classList.add('hidden');
     emptyState.classList.remove('hidden');
     document.getElementById('articlePagination').classList.add('hidden');
     return;
  }

  tbody.classList.remove('hidden');
  emptyState.classList.add('hidden');
  document.getElementById('articlePagination').classList.remove('hidden');

  // 2. Apply Pagination (Client-side slicing)
  const offset = (articleCurrentPage - 1) * limit;
  const paginatedArticles = filteredArticles.slice(offset, offset + limit);

  paginatedArticles.forEach(a=>{
    const row = document.createElement('tr');
    row.className='hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
    const titlePreview = a.title.length > 25 ? a.title.slice(0, 22) + '...' : a.title;
    row.innerHTML = `
      <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${titlePreview}</td>
      <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${a.categ}/${a.sub}</td>
       <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${a.user}</td>
       <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${a.views}</td>
      <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
          <button onclick="deleteArticle('${a.id}')" class="delete-button">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  // 3. Update Pagination UI
  const start = offset + 1;
  const end = Math.min(offset + limit, totalItems);
  document.getElementById('articlePagingInfo').textContent = 
    `Showing ${start}-${end} of ${totalItems} articles (Page ${articleCurrentPage}/${totalPages})`;
  
  document.getElementById('articlePrev').disabled = articleCurrentPage <= 1;
  document.getElementById('articleNext').disabled = articleCurrentPage >= totalPages;
}

async function deleteArticle(aid){
  showConfirmation(`Are you sure you want to delete the article with ID: ${aid}?`, async () => {
    const data = await fetchJSON('/admin/delete_article',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({admin_id, token:admin_token, article_id:aid})
    });
    if (data && data.success) {
        loadArticles(); // Re-load and re-render
    }
  });
}

// --- Comment Functions ---

async function loadComments(){
  const data = await fetchJSON(`/admin/comments?id=${admin_id}&token=${admin_token}`);
  comments = data?.comments || [];
  
  // NEW: Update Stat Card
  document.getElementById('totalCommentsStat').textContent = comments.length;
  
  commentCurrentPage = 1;
  renderComments();
}

function renderComments(resetPage = 0){
  const tbody = document.getElementById('commentsList');
  const emptyState = document.getElementById('commentsEmptyState');
  const search = document.getElementById('commentSearch').value.toLowerCase();
  const limit = parseInt(document.getElementById('commentLimit').value, 10);
  
  if (resetPage) commentCurrentPage = 1;
  
  tbody.innerHTML = '';

  // 1. Apply Search/Filter
  const filteredComments = comments.filter(c => 
    c.content.toLowerCase().includes(search) || c.user.toLowerCase().includes(search)
  );
  
  const totalItems = filteredComments.length;
  const totalPages = Math.ceil(totalItems / limit);

  if (commentCurrentPage > totalPages && totalPages > 0) {
    commentCurrentPage = totalPages;
  } else if (commentCurrentPage < 1 && totalPages > 0) {
    commentCurrentPage = 1;
  } else if (totalPages === 0) {
    commentCurrentPage = 0;
  }

  if (totalItems === 0) {
     tbody.classList.add('hidden');
     emptyState.classList.remove('hidden');
     document.getElementById('commentPagination').classList.add('hidden');
     return;
  }

  tbody.classList.remove('hidden');
  emptyState.classList.add('hidden');
  document.getElementById('commentPagination').classList.remove('hidden');

  // 2. Apply Pagination (Client-side slicing)
  const offset = (commentCurrentPage - 1) * limit;
  const paginatedComments = filteredComments.slice(offset, offset + limit);

  paginatedComments.forEach(c=>{
    const row = document.createElement('tr');
    row.className='hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
    const contentPreview = c.content.length > 50 ? c.content.substring(0, 30) + '...' : c.content;
    row.innerHTML = `
      <td class="px-3 py-3 text-sm font-medium text-gray-900 dark:text-gray-100">${contentPreview}</td>
      <td class="px-3 py-3 whitespace-nowrap text-xs font-mono text-gray-500 dark:text-gray-400">${c.user} | ${c.user_id}</td>
      <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-medium">
          <button onclick="deleteComment('${c.id}')" class="delete-button">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
  
  // 3. Update Pagination UI
  const start = offset + 1;
  const end = Math.min(offset + limit, totalItems);
  document.getElementById('commentPagingInfo').textContent = 
    `Showing ${start}-${end} of ${totalItems} comments (Page ${commentCurrentPage}/${totalPages})`;
  
  document.getElementById('commentPrev').disabled = commentCurrentPage <= 1;
  document.getElementById('commentNext').disabled = commentCurrentPage >= totalPages;
}

async function deleteComment(cid){
  showConfirmation(`Are you sure you want to delete the comment with ID: ${cid}?`, async () => {
    const data = await fetchJSON('/admin/delete_comment',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({admin_id, token:admin_token, comment_id:cid})
    });
    if (data && data.success) {
        loadComments(); // Re-load and re-render
    }
  });
}

function runBackup() {
  showConfirmation('This will start a full database backup. Do you want to proceed?', () => {
    console.log('Starting database backup...');
    const statusElement = document.getElementById('systemStatus');
    statusElement.textContent = 'Backing up...';
    statusElement.classList.remove('bg-primary-100', 'text-primary-800', 'dark:bg-primary-800', 'dark:text-primary-100');
    statusElement.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-800', 'dark:text-yellow-100');

    setTimeout(() => {
        statusElement.textContent = 'Operational';
        statusElement.classList.remove('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-800', 'dark:text-yellow-100');
        statusElement.classList.add('bg-primary-100', 'text-primary-800', 'dark:bg-primary-800', 'dark:text-primary-100');
        
        console.log("Database backup complete!"); 
    }, 2000);
  });
}

function clearCache() {
  showConfirmation('Are you sure you want to clear all application cache? This may temporarily slow down performance.', () => {
    console.log('Clearing application cache...');
    const statusElement = document.getElementById('systemStatus');
    statusElement.textContent = 'Clearing Cache...';
    statusElement.classList.remove('bg-primary-100', 'text-primary-800', 'dark:bg-primary-800', 'dark:text-primary-100');
    statusElement.classList.add('bg-gray-100', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-100');

    setTimeout(() => {
        statusElement.textContent = 'Operational';
        statusElement.classList.remove('bg-gray-100', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-100');
        statusElement.classList.add('bg-primary-100', 'text-primary-800', 'dark:bg-primary-800', 'dark:text-primary-100');

        console.log("Cache cleared successfully!");
    }, 1500);
  });
}

window.onload = function() {
  initTheme();
  
  // Ensure default limit is set to 10
  document.getElementById('userLimit').value = 10;
  document.getElementById('articleLimit').value = 10;
  document.getElementById('commentLimit').value = 10;
  
  if(admin_id && admin_token){
    loadUsers();
    loadArticles();
    loadComments();
  }else{
    showAuthError();
  }
}
</script>
</body>
</html>